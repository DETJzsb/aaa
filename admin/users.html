<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin ‚Äì Users</title>
  <link rel="stylesheet" href="css/ui.css">
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2 class="logo">ADMIN</h2>
  <a href="index.html">Dashboard</a>
  <a class="active">Users</a>
  <a href="history.html">Historic</a>
  <a href="#" id="logoutBtn" style="margin-top:30px;color:#ef4444">Logout</a>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <h1>Users Management</h1>
    <button class="btn primary" onclick="openAdd()">+ Add User</button>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Department</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="users-table"></tbody>
    </table>
  </div>
</div>

<!-- ADD / EDIT USER -->
<div class="modal" id="userModal">
  <div class="modal-card">
    <h3 id="modalTitle">Add User</h3>

    <input id="fullName" placeholder="Full name *">
    <input id="email" placeholder="Email *">

    <select id="role" onchange="handleRoleChange()">
      <option value="">Select role *</option>
      <option value="admin">Admin</option>
      <option value="directeur">Directeur</option>
      <option value="sous-directeur">Sous Directeur</option>
      <option value="supervisor">Supervisor</option>
      <option value="agent">Agent</option>
    </select>

    <!-- Department (conditional) -->
    <select id="department" style="display:none">
      <option value="">Select department *</option>
      <option>ZSB</option>
      <option>JIS</option>
      <option>N-JIS</option>
      <option>R-S</option>
    </select>

    <div class="modal-actions">
      <button class="btn ghost" onclick="closeModal()">Cancel</button>
      <button class="btn primary" onclick="saveUser()">Save</button>
    </div>
  </div>
</div>

<!-- DELETE -->
<div class="modal" id="deleteModal">
  <div class="modal-card">
    <h3>Delete user?</h3>
    <p class="muted">This action cannot be undone.</p>

    <div class="modal-actions">
      <button class="btn ghost" onclick="closeDelete()">Cancel</button>
      <button class="btn danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script type="module" src="js/admin-auth.js"></script>
<script type="module" src="js/supabase-admin.js"></script>

<!-- UI LOGIC ONLY -->
<script>
  let editIndex = null;
  let users = [];

  function openAdd(){
    editIndex = null;
    document.getElementById('modalTitle').innerText = 'Add User';
    document.getElementById('userModal').classList.add('show');
  }

  function closeModal(){
    document.getElementById('userModal').classList.remove('show');
  }

  function handleRoleChange(){
    const role = document.getElementById('role').value;
    const dep = document.getElementById('department');

    if(role === 'sous-directeur'){
      dep.style.display = 'block';
    }else{
      dep.style.display = 'none';
      dep.value = '';
    }
  }

  function saveUser(){
    const name = fullName.value.trim();
    const mail = email.value.trim();
    const role = document.getElementById('role').value;
    const dep = department.value;

    if(!name || !mail || !role){
      alert('Fill required fields');
      return;
    }

    if(role === 'sous-directeur' && !dep){
      alert('Department required for Sous Directeur');
      return;
    }

    const user = { name, mail, role, dep };

    if(editIndex === null){
      users.push(user);
    }else{
      users[editIndex] = user;
    }

    renderUsers();
    closeModal();
  }

  function renderUsers(){
    const tbody = document.getElementById('users-table');
    tbody.innerHTML = '';

    users.forEach((u,i)=>{
      tbody.innerHTML += `
        <tr>
          <td>${u.name}</td>
          <td>${u.mail}</td>
          <td>${u.role}</td>
          <td>${u.dep || '-'}</td>
          <td class="actions">
            <button onclick="editUser(${i})">‚úèÔ∏è</button>
            <button class="danger" onclick="deleteUser(${i})">üóë</button>
          </td>
        </tr>
      `;
    });
  }

  function editUser(i){
    editIndex = i;
    const u = users[i];
    fullName.value = u.name;
    email.value = u.mail;
    role.value = u.role;
    handleRoleChange();
    department.value = u.dep || '';
    openAdd();
  }

  let deleteIndex = null;
  function deleteUser(i){
    deleteIndex = i;
    deleteModal.classList.add('show');
  }
  function closeDelete(){
    deleteModal.classList.remove('show');
  }
  function confirmDelete(){
    users.splice(deleteIndex,1);
    renderUsers();
    closeDelete();
  }
</script>

</body>
</html>
